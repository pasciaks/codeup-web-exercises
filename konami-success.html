<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cody The Duck</title>
    <style>

        * {
            box-sizing: border-box;
            position: absolute;
            user-select: none;
        }

        img {
            width: 100px;
        }
    </style>
</head>
<body style="overflow: hidden">

<p id="info"></p>

<img alt="" src="images/cody.webp" style="z-index: 10">

<script defer>

    let totalCollisions = 0;
    let collisionsEnabled = false;
    let startingSpeed = 100;
    let bullets = [];
    let bulletSpeed = 10;
    let shootSpeed = 1500;
    let image = document.querySelector('img');

    image.width = 100;
    image.height = 100;

    let x = Math.floor(window.innerWidth / 2);
    let y = Math.floor(window.innerHeight / 2);

    let dx = 0;
    let dy = 0;

    function moveBullets() {
        if (bullets.length > 1000) {
            bullets = [];
            document.querySelectorAll('.bullet').forEach((item) => {
                item.parentNode.removeChild(item);
            })
        }
        bullets.forEach((bullet, index) => {
            bullet.x += bullet.dirX * bullet.bulletSpeedX;
            bullet.y += bullet.dirY * bullet.bulletSpeedY;
            if (bullet.x < 0 || bullet.x > window.innerWidth) {
                bullet.dirX *= -1;
                bullet.x += bullet.dirX * bulletSpeed;
            }
            if (bullet.y < 0 || bullet.y > window.innerHeight) {
                bullet.dirY *= -1;
                bullet.y += bullet.dirY * bulletSpeed;
            }
            setElementLocation(bullet, bullet.x, bullet.y);
        })
    }

    function checkCollisions() {

        if (!collisionsEnabled) {
            return;
        }

        let hasCollision = false;

        bullets.forEach((bullet) => {
            if (Date.now() - bullet.life > 1000) {
                bullet.style.border = "3px solid red";
                if (bullet.x > x - 50 - 5) {
                    if (bullet.x < x + 50 + 5) {
                        if (bullet.y > y - 50 - 5) {
                            if (bullet.y < y + 50 + 5) {
                                hasCollision = true;
                                bullet.life = 0;
                                bullet.x = -1000;
                                bullet.y = -1000;
                            }
                        }
                    }
                }
            }

        });

        if (hasCollision) {
            totalCollisions++;
            document.getElementById('info').innerText = `${totalCollisions} Collisions`;
            image.style.border = '10px solid red';
        } else {
            image.style.border = 'none';
        }

    }

    function shoot(sx = x, sy = y, directionX, directionY) {
        // dx = 0;
        // dy = 0;
        let bullet = document.createElement('div');
        bullet.classList.add('bullet');
        bullet.style.zIndex = "1";
        bullet.bulletSpeedX = bulletSpeed + 1.5 - Math.random() * 3;
        bullet.bulletSpeedY = bulletSpeed + 1.5 - Math.random() * 3;
        let bstartx = sx + directionX * bullet.bulletSpeedX * 2;
        let bstarty = sy + directionY * bullet.bulletSpeedY * 2;
        bullet.x = Math.floor(bstartx);
        bullet.y = Math.floor(bstarty);
        bullet.life = Date.now();
        bullet.style.width = '10px';
        bullet.style.height = '10px';
        bullet.style.position = 'absolute';
        bullet.style.left = `${bullet.x}px`;
        bullet.style.top = `${bullet.y}px`;
        bullet.style.borderRadius = '100%';
        bullet.style.background = 'red';
        bullet.style.border = '1px solid blue';
        bullet.dirX = directionX;
        bullet.dirY = directionY;
        document.body.append(bullet);
        bullets.push(bullet);
    }

    function keyDown(event) {

        switch (event.key) {
            case "ArrowLeft":
                dx = -10;
                dy = 0;
                break;
            case "ArrowRight":
                dx = 10;
                dy = 0;
                break;
            case "ArrowUp":
                dy = -10;
                dx = 0;
                break;
            case "ArrowDown":
                dy = 10;
                dx = 0;
                break;

            case " ":
                dx = 0;
                dy = 0;
                break;

            case "a":
            case "A":
                shoot(x, y, -1, 0);
                break;

            case "d":
            case "D":
                shoot(x, y, 1, 0);
                break;

            case "w":
            case "W":
                shoot(x, y, 0, -1);
                break;

            case "x":
            case "X":
                shoot(x, y, 0, 1);
                break;

            case "q":
            case "Q":
                shoot(x, y, -1, -1);
                break;

            case "e":
            case "E":
                shoot(x, y, 1, -1);
                break;

            case "z":
            case "Z":
                shoot(x, y, -1, 1);
                break;

            case "c":
            case "C":
                shoot(x, y, 1, 1);
                break;

        }

    }

    document.addEventListener("keydown", event => keyDown(event));

    document.addEventListener('mousedown', (event) => {
        let rect = event.target.getBoundingClientRect();
        let x = event.clientX - rect.left; //x position within the element.
        let y = event.clientY - rect.top;  //y position within the element.

        if (x < window.innerWidth / 2) {
            shoot(x, y, -1, getRandomDirection());
        }
        if (x > window.innerWidth / 2) {
            shoot(x, y, 1, getRandomDirection());
        }
        if (y < window.innerHeight / 2) {
            shoot(x, y, getRandomDirection(), -1);
        }
        if (y > window.innerHeight / 2) {
            shoot(x, y, getRandomDirection(), 1);
        }

    });

    // document.addEventListener('mousemove', (event) => {
    //     let rect = event.target.getBoundingClientRect();
    //     let x = event.clientX - rect.left; //x position within the element.
    //     let y = event.clientY - rect.top;  //y position within the element.
    //
    //     if (x < window.innerWidth / 2) {
    //         dx = -10;
    //     }
    //     if (x > window.innerWidth / 2) {
    //         dx = 10;
    //     }
    //     if (y < window.innerHeight / 2) {
    //         dy = -10;
    //     }
    //     if (y > window.innerHeight / 2) {
    //         dy = 10;
    //     }
    // });

    function setLocation() {
        image.style.position = 'absolute';
        image.style.left = `${Math.floor(x - 50)}px`;
        image.style.top = `${Math.floor(y - 50)}px`;
    }

    function setElementLocation(element, x, y, sizeX = 5, sizeY = 5) {
        // console.log(element, x, y);
        image.style.position = 'absolute';
        element.style.left = `${x - sizeX}px`;
        element.style.top = `${y - sizeY}px`;
    }

    function move() {
        x += dx;
        y += dy;
        if (x < 0 || x > window.innerWidth) {
            dx *= -1;
            x += dx;
        }
        if (y < 0 || y > window.innerHeight) {
            dy *= -1;
            y += dy;
        }
        setLocation();
    }

    let intervalSpeed = setInterval(function () {
        move();
        moveBullets();
        checkCollisions();
    }, startingSpeed);

    setInterval(function () {

        startingSpeed -= 10;

        if (startingSpeed < 30) {
            startingSpeed = 30;
        }

        if (intervalSpeed) {
            clearInterval(intervalSpeed);
        }

        intervalSpeed = setInterval(function () {
            move();
            moveBullets();
            checkCollisions();
        }, startingSpeed);

    }, 5000);

    function getRandomDirection() {
        if (Math.random() > .5) {
            return -1
        } else {
            return 1
        }
    }

    setTimeout(function () {
        collisionsEnabled = true;
    }, 5000);

    setInterval(function () {
        let ttx = getRandomDirection();
        if (ttx === -1) {
            ttx = 50;
        } else {
            ttx = window.innerWidth - 50;
        }
        let tty = getRandomDirection();
        if (tty === -1) {
            tty = 50;
        } else {
            tty = window.innerHeight - 50;
        }
        shoot(ttx, tty, getRandomDirection(), getRandomDirection());
    }, shootSpeed);

</script>
</body>
</html>